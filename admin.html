<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>EDS PROGRAM EBROADCAST - Admin</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h1 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    button { margin: 5px; padding: 8px 12px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Admin - Contacts</h1>

  <div style="text-align:center;">
    <button id="deleteSelected">Supprimer Sélection</button>
    <button id="deleteAll">Supprimer Tout</button>
    <button id="downloadContacts">Télécharger Contacts (CSV)</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Sélection</th>
        <th>Nom</th>
        <th>Prénom</th>
        <th>Numéro WhatsApp</th>
      </tr>
    </thead>
    <tbody id="contactTable"></tbody>
  </table>

  <script>
    const CORRECT_PASSWORD = "04004749"; // Mot de passe admin
    const API_KEY = "nfp_guuy1oVgA3kZQwj2T9dayVxjEyyhbdQHdad4"; // Remplacer par ton API Key Netlify
    const FORM_ID = "68aeae82b253f900084dc5d4"; // Remplacer par ton Form ID

    let contacts = []; // Tableau qui contiendra les soumissions

    async function fetchContacts() {
      try {
        const res = await fetch(`https://api.netlify.com/api/v1/forms/${FORM_ID}/submissions`, {
          headers: { "Authorization": `Bearer ${API_KEY}` }
        });
        const submissions = await res.json();
        contacts = submissions.map(sub => ({
          nom: sub.data.nom || "",
          prenom: sub.data.prenom || "",
          numero: sub.data.numero || ""
        }));
        renderContacts();
      } catch (err) {
        console.error("Erreur récupération Netlify:", err);
      }
    }

    const table = document.getElementById("contactTable");

    function renderContacts(){
      table.innerHTML = "";
      contacts.forEach((c, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td><input type="checkbox" data-index="${index}"></td>
          <td>${c.nom}</td>
          <td>${c.prenom}</td>
          <td>${c.numero}</td>
        `;
        table.appendChild(row);
      });
    }

    document.getElementById("deleteSelected").addEventListener("click", function(){
      const checkboxes = document.querySelectorAll("input[type='checkbox']:checked");
      const toDelete = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));
      contacts = contacts.filter((_, i) => !toDelete.includes(i));
      renderContacts();
    });

    document.getElementById("deleteAll").addEventListener("click", function(){
      if(confirm("Voulez-vous vraiment supprimer TOUS les contacts ?")){
        contacts = [];
        renderContacts();
      }
    });

    document.getElementById("downloadContacts").addEventListener("click", function(){
      let csv = "Nom,Prénom,Numéro WhatsApp\n";
      contacts.forEach(c => {
        csv += `${c.nom},${c.prenom},${c.numero}\n`;
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "contacts.csv";
      a.click();
      URL.revokeObjectURL(url);
    });

    // Récupération des contacts depuis Netlify au chargement
    fetchContacts();
  </script>
</body>
</html>
