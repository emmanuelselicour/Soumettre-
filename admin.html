<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>EDS ‚Äî Admin</title>
    <style>
      body{font-family:Inter,system-ui;background:#f8fafc;color:#0f172a;padding:18px}
      .login{max-width:480px;margin:30px auto;background:white;padding:20px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.06)}
      input{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #e6eef5}
      .row{display:flex;gap:8px}
      button{background:#0ea5a4;color:white;padding:8px 12px;border-radius:8px;border:0}
      table{width:100%;border-collapse:collapse;margin-top:12px}
      th,td{border-bottom:1px solid #e6eef5;padding:8px;text-align:left}
      .muted{color:#64748b}
    </style>
  </head>
  <body>
    <div class="login" id="loginBox">
      <h2>Administration EDS</h2>
      <p>Confirme ton mot de passe admin pour acc√©der au panneau.</p>
      <label>Mot de passe</label>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="adminPass" type="password" placeholder="04004749" />
        <button id="toggleEye">üëÅÔ∏è</button>
      </div>
      <div style="margin-top:10px">
        <button id="loginBtn">Se connecter</button>
      </div>
      <p class="muted">Ton mot de passe de confirmation est requis avant toute suppression.</p>
    </div>

    <div id="adminPanel" style="display:none;max-width:1100px;margin:10px auto">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>
          <input id="searchInput" placeholder="Rechercher par nom, whatsapp..." style="padding:8px;border-radius:8px;border:1px solid #e6eef5;width:360px" />
          <button id="searchBtn">Rechercher</button>
        </div>
        <div>
          <label><input id="useDirect" type="checkbox"/> mode direct (token en m√©moire)</label>
          <input id="apiToken" placeholder="colle le API token ici (optionnel)" style="width:360px;margin-left:12px;padding:8px;border-radius:8px;border:1px solid #e6eef5" />
        </div>
      </div>

      <div style="background:white;padding:12px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.06)">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3>Soumissions</h3>
          <div>
            <button id="refresh">rafra√Æchir</button>
            <button id="deleteAll">supprimer tout</button>
          </div>
        </div>

        <table id="subTable"><thead><tr><th>Nom</th><th>Pr√©nom</th><th>WhatsApp</th><th>Fichiers</th><th>Actions</th></tr></thead><tbody></tbody></table>
      </div>
    </div>

    <script>
      const SITE_ID = '68ae6ed558338b00088302f7'
      const correctAdminPassword = '04004749'

      document.getElementById('toggleEye').addEventListener('click', ()=>{
        const p = document.getElementById('adminPass')
        p.type = p.type === 'password' ? 'text' : 'password'
      })

      document.getElementById('loginBtn').addEventListener('click', ()=>{
        const v = document.getElementById('adminPass').value
        if(v === correctAdminPassword){ document.getElementById('loginBox').style.display='none'; document.getElementById('adminPanel').style.display='block'; loadSubmissions() }
        else alert('Mot de passe incorrect')
      })

      async function apiFetch(path, opts={}){
        const useDirect = document.getElementById('useDirect').checked
        if(useDirect){
          const token = document.getElementById('apiToken').value.trim()
          if(!token){ alert('colle ton token dans la zone en haut puis coche mode direct') ; throw new Error('no token') }
          opts.headers = Object.assign({}, opts.headers, { Authorization: 'Bearer '+token })
          const r = await fetch('https://api.netlify.com'+path, opts)
          if(!r.ok) throw new Error('Erreur API: '+r.status)
          return r.json()
        } else {
          const url = '/.netlify/functions' + path
          const r = await fetch(url, opts)
          if(!r.ok) throw new Error('Erreur fonctions: '+r.status)
          return r.json()
        }
      }

      async function loadSubmissions(){
        try{
          const useDirect = document.getElementById('useDirect').checked
          let data
          if(useDirect){
            const token = document.getElementById('apiToken').value.trim()
            data = await (await fetch(`https://api.netlify.com/api/v1/sites/${SITE_ID}/submissions`, { headers:{ Authorization: 'Bearer '+token } })).json()
          } else {
            data = await apiFetch('/get_submissions?site_id='+SITE_ID)
          }
          renderTable(data)
        }catch(e){ console.error(e); alert('Erreur en chargeant les soumissions ‚Äî regarde la console') }
      }

      function renderTable(data){
        const tbody = document.querySelector('#subTable tbody')
        tbody.innerHTML = ''
        data.forEach(s=>{
          const tr = document.createElement('tr')
          const nom = s.data.nom || s.data.name || ''
          tr.innerHTML = `<td>${escapeHtml(nom)}</td><td>${escapeHtml(s.data.prenom||'')}</td><td>${escapeHtml(s.data.whatsapp||'')}</td><td>${fileLinksHtml(s)}</td><td><button data-id="${s.id}" class="del">supprimer</button></td>`
          tbody.appendChild(tr)
        })
        document.querySelectorAll('.del').forEach(btn=>btn.addEventListener('click', async e=>{
          const id = e.currentTarget.dataset.id
          const pass = prompt('Confirme ton mot de passe admin pour supprimer')
          if(pass !== correctAdminPassword){ alert('mot de passe incorrect') ; return }
          try{
            const useDirect = document.getElementById('useDirect').checked
            if(useDirect){
              const token = document.getElementById('apiToken').value.trim()
              const r = await fetch(`https://api.netlify.com/api/v1/submissions/${id}`, { method:'DELETE', headers:{ Authorization: 'Bearer '+token } })
              if(!r.ok) throw new Error('delete failed')
            } else {
              await apiFetch('/delete_submission?submission_id='+id, { method:'DELETE' })
            }
            alert('supprim√©')
            loadSubmissions()
          }catch(err){ console.error(err); alert('erreur suppression') }
        }))
      }

      function fileLinksHtml(s){
        if(!s.files || s.files.length===0) return ''
        return s.files.map(f=>`<a href="${f.url}" target="_blank">${f.name}</a>`).join('<br>')
      }

      function escapeHtml(t){ if(!t) return ''; return String(t).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) }

      document.getElementById('refresh').addEventListener('click', loadSubmissions)

      document.getElementById('deleteAll').addEventListener('click', async ()=>{
        if(!confirm('Supprimer TOUTES les soumissions (irr√©versible) ?')) return
        const pass = prompt('Confirme ton mot de passe admin pour supprimer TOUT')
        if(pass !== correctAdminPassword){ alert('mot de passe incorrect') ; return }
        try{
          const useDirect = document.getElementById('useDirect').checked
          if(useDirect){
            const token = document.getElementById('apiToken').value.trim()
            const r = await fetch(`https://api.netlify.com/api/v1/sites/${SITE_ID}/forms/eds-contact`, { method:'DELETE', headers:{ Authorization: 'Bearer '+token } })
            if(!r.ok) throw new Error('delete form failed')
          } else {
            await apiFetch('/delete_submission?delete_all=1&site_id='+SITE_ID, { method:'DELETE' })
          }
          alert('toutes les soumissions supprim√©es')
          loadSubmissions()
        }catch(err){ console.error(err); alert('erreur suppression') }
      })

      document.getElementById('searchBtn').addEventListener('click', ()=>{
        const q = document.getElementById('searchInput').value.toLowerCase()
        document.querySelectorAll('#subTable tbody tr').forEach(tr=>{
          const txt = tr.textContent.toLowerCase()
          tr.style.display = txt.includes(q) ? '' : 'none'
        })
      })
    </script>
  </body>
</html>
